{% extends 'freesources/base.html' %}
{% block head_content %}
   <!--  <h1 class="text-center">Freesources Main page</h1>
    <h3 class="text-center">- presented by <a href="https://github.com/Team-Ace">Team ACE</a> at Columbia University</h3> -->
    <div style = "height: 50px"></div>
{% endblock head_content %}

{% block map_content %}
    <div id="map" style="height: 800px"></div>

<script>

    var map = L.map('map').setView([40.807722, -73.964110], 16);

    L.tileLayer('http://{s}.tile.stamen.com/terrain/{z}/{x}/{y}.jpg', {
        maxZoom: 18,
        attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.'
    }).addTo(map);
    
    {% for item in items %}   
       //    add marker to the map
                var marker = new L.marker(['{{item.latitude}}','{{item.longitude}}']);
                var popup = "<h4 id=\"'{{item.item_id}}'\">Item Details</h4>";
                popup += "<table class=\"table\">";
                popup += "<tr><th>Creator</th><td>";
                popup += '{{item.username}}';
                popup += "</td></tr>";
                popup += "<tr><th>Tag</th><td>";
                popup += '{{item.tag_name}}';
                popup += "</td></tr>";
                popup += "<tr><th>Location</th><td>";
                popup += '{{item.location}}';
                popup += "</td></tr>";
                popup += "<tr><th>Description</th><td>";
                popup += '{{item.description}}';
                popup += "</td></tr>";
                popup += "<tr><th>Type</th><td>";
                popup += '{{item.expire_type}}';
                popup += "</td></tr>";
                popup += "<tr><th>Start Time</th><td>";
                popup += '{{item.start_time}}';
                popup += "</td></tr>";
                popup += "<tr><th>Expiration</th><td>";
                popup += '{{item.expiration}}';
                popup += "</td></tr>";

                popup += "<tr><th>Overall Feedback</th>";
                popup += "<td><table class=\"table table-bordered\"><tr class=\"bg-success\"><th>Confirm</th><td>";
                popup += '{{item.confirm}}';
                popup += "</td></tr><tr class=\"bg-danger\"><th>Rejection - False Item</th><td>";
                popup += '{{item.rej_false}}';
                popup += "</td></tr><tr class=\"bg-warning\"><th>Rejection - Expired</th><td>";
                popup += '{{item.rej_exp}}';
                popup += "</td></tr></table></td></tr>";
            

                if('{{item.feedback_type}}' == 'None'){

                }
                if('{{item.feedback_type}}' != 'None'){
                    popup += "<tr><th>Your Feedback</th><td><table>";
                    if('{{item.feedback_type}}' == 'confirm'){
                        popup += "<tr class=\"confirm\"><th>Confirm</th></tr>";
                    }
                    else if('{{item.feedback_type}}' == 'rej_false'){
                        popup += "<tr class=\"rej_false\"><th>Rejection - False Item</th></tr>";
                    }
                    else{
                        popup += "<tr class=\"rej_exp\"><th>Rejection - Expired</th></tr>";
                    }
                    popup += '<tr></tr></table></td></tr>\
                    <tr><th>Change Feedback</th><td>';

                }
                else{
                    popup += '<tr><th>Give Feedback</th><td>';
                }

                   //    change feedback buttons
                    var url = "{% url 'feedback' 'confirm' item.item_id %}";
                    popup += '<table class="table"><tr><td>';
                    popup += '<button onclick="feedback(this,\''+ url +'\')" class="btn btn-success btn-block" data-toggle="modal" data-target="#submitFeedback">Confirm</button></td><td></td></tr>';

                    url = "{% url 'feedback' 'rej_false' item.item_id %}";
                    popup += '<tr><td>';
                    popup += '<button onclick="feedback(this,\''+ url +'\')" class="btn btn-danger btn-block" data-toggle="modal" data-target="#submitFeedback">Reject - False Item</button></td>';

                    url = "{% url 'feedback' 'rej_exp' item.item_id %}";
                    popup += '<tr><td>';
                    popup += '<button onclick="feedback(this,\''+ url +'\')" class="btn btn-warning btn-block" data-toggle="modal" data-target="#submitFeedback">Reject - Expired</button></td></tr></table></td></tr>';



                popup += "</table>";
                marker.bindPopup(popup);
                map.addLayer(marker);        
    {% endfor %}
    map.on('click', onMapClick);

</script>


<!--     temporary adding item function, to be improved later      -->
        <div id="form" style="display:none">
            <form id = "submit_item" class = "form-horizontal" action="" method="POST">
                {% csrf_token %}
                {{form.as_table}}
                <br>
            </form>
            <button class="btn btn-primary" data-toggle="modal" data-target="#submitItem" onclick="additem(this)">Submit New Item</button>
        </div>

    <h2 class="text-center">Items table information list (for debug use only)</h2>
    <table class="table">
        <tr>
        <th>Tag</th>
        <th>Start Time</th>
        <th>Expiration</th>
        <th>Location</th>
        <th>Description</th>
        </tr>
        {% for item in items %}
        <tr>
            <td>{{ item.tag_name }}</td>
            <td>{{ item.start_time}}</td>
            <td>{{ item.expiration}}</td>
            <td>{{ item.location}}</td>
            <td>{{ item.description}}</td>
            </tr>
        {% endfor %}
    </table>
    
        <!-- Modal for add item confirmation -->
        <div id="submitItem" class="modal fade" role="dialog">
          <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Confirm Item Submission</h4>
              </div>
              <div class="modal-body">
                <p>Are you sure to submit this item?</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal" id="confirmSubmitItem">Confirm</button>
              </div>
            </div>

          </div>
        </div>

        <!-- Modal for submit feedback confirmation -->
        <div id="submitFeedback" class="modal fade" role="dialog">
          <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Confirm Feedback Submission</h4>
              </div>
              <div class="modal-body">
                <p>Are you sure to submit feedback?</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal" id="confirmSubmitFeedback">Confirm</button>
              </div>
            </div>

          </div>
        </div>

{% endblock map_content %}